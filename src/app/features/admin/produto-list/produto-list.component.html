<div class="card">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <p-toolbar styleClass="mb-4 gap-2">
        <ng-template pTemplate="left">
            <p-button label="Novo Produto" icon="pi pi-plus" styleClass="p-button-success" (onClick)="openNew()"></p-button>
        </ng-template>
    </p-toolbar>

    <p-table [value]="produtos" [loading]="loading" [rows]="10" [paginator]="true" [tableStyle]="{'min-width': '75rem'}"
             [rowsPerPageOptions]="[10, 25, 50]">
        <ng-template pTemplate="header">
            <tr>
                <th>Código</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Preço</th>
                <th>Estoque</th>
                <th>Ações</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-p>
            <tr>
                <td>{{p.codigoProduto}}</td>
                <td>{{p.nome}}</td>
                <td>{{p.categoria}}</td>
                <td>{{p.precoUnitario | currency:'BRL'}}</td>
                <td>
                    <p-tag [value]="p.quantidadeEstoque.toString()" [severity]="getSeverity(p.quantidadeEstoque)"></p-tag>
                </td>
                <td>
                    <p-button icon="pi pi-pencil" styleClass="p-button-rounded p-button-text" (onClick)="edit(p)" pTooltip="Editar"></p-button>
                    <p-button icon="pi pi-trash" styleClass="p-button-rounded p-button-text p-button-danger" (onClick)="delete(p)" pTooltip="Excluir"></p-button>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="6" class="text-center p-4">Nenhum produto encontrado.</td>
            </tr>
        </ng-template>
    </p-table>

    <p-dialog [(visible)]="produtoDialog" [style]="{width: '450px'}" header="Detalhes do Produto" [modal]="true" styleClass="p-fluid">
        <ng-template pTemplate="content">
            <form [formGroup]="produtoForm">
                
                <div class="field mb-3">
                    <label for="codigo">Código do Produto *</label>
                    <input type="text" pInputText id="codigo" formControlName="codigoProduto" required autofocus />
                    <small class="p-error block" *ngIf="produtoForm.get('codigoProduto')?.invalid && produtoForm.get('codigoProduto')?.dirty">
                        O código é obrigatório.
                    </small>
                </div>

                <div class="field mb-3">
                    <label for="nome">Nome *</label>
                    <input type="text" pInputText id="nome" formControlName="nome" required />
                    <small class="p-error block" *ngIf="produtoForm.get('nome')?.invalid && produtoForm.get('nome')?.dirty">
                        O nome é obrigatório.
                    </small>
                </div>

                <div class="field mb-3">
                    <label for="categoria">Categoria</label>
                    <input type="text" pInputText id="categoria" formControlName="categoria" />
                </div>

                <div class="formgrid grid">
                    <div class="field col mb-3">
                        <label for="preco">Preço (R$) *</label>
                        <p-inputNumber id="preco" formControlName="precoUnitario" mode="currency" currency="BRL" locale="pt-BR"></p-inputNumber>
                    </div>

                    <div class="field col mb-3">
                        <label for="estoque">Estoque Inicial *</label>
                        <p-inputNumber 
                            id="estoque" 
                            formControlName="quantidadeEstoque" 
                            [disabled]="!!produtoForm.get('id')?.value">
                        </p-inputNumber>
                        
                        <small *ngIf="produtoForm.get('id')?.value" class="text-500 block mt-1" style="font-size: 0.8rem;">
                            <i class="pi pi-info-circle"></i> Use o menu "Estoque" para ajustes.
                        </small>
                    </div>
                </div>
            </form>
        </ng-template>

        <ng-template pTemplate="footer">
            <p-button label="Cancelar" icon="pi pi-times" styleClass="p-button-text" (onClick)="hideDialog()"></p-button>
            <p-button label="Salvar" icon="pi pi-check" styleClass="p-button-text" (onClick)="save()"></p-button>
        </ng-template>
    </p-dialog>
</div>